<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/header') %>
  <style>
    .stats-card { background: #fff; border-radius: 15px; padding: 20px; border: 1px solid #eee; }
  </style>
</head>
<body class="bg-light">
  <%- include('../partials/admin-nav') %>

  <div class="container my-5">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
      <div>
        <h2 class="fw-800 mb-1 fw-bold">Subscribers</h2>
        <p class="text-muted mb-0">Manage your email audience and delivery.</p>
      </div>
      <form class="d-flex gap-2" method="get" action="/developer/subscribers">
        <input
          type="text"
          name="q"
          class="form-control form-control-sm bg-white border"
          placeholder="Search by email..."
          value="<%= search || '' %>"
        >
        <select name="status" class="form-select form-select-sm">
          <option value="">All</option>
          <option value="active" <%= status === 'active' ? 'selected' : '' %>>Active</option>
          <option value="blocked" <%= status === 'blocked' ? 'selected' : '' %>>Blocked</option>
        </select>
        <button class="btn btn-sm btn-outline-dark fw-bold" type="submit">Filter</button>
      </form>
    </div>

    <!-- Stats + Chart -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="stats-card shadow-sm">
          <div class="text-muted small mb-1">Total subscribers</div>
          <div class="h4 mb-0"><%= stats.total || 0 %></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stats-card shadow-sm">
          <div class="text-muted small mb-1">Active</div>
          <div class="h4 mb-0"><%= stats.active || 0 %></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stats-card shadow-sm">
          <div class="text-muted small mb-1">Blocked</div>
          <div class="h4 mb-0"><%= stats.blocked || 0 %></div>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm mb-4" style="border-radius: 15px;">
      <div class="card-body">
        <h6 class="text-muted small mb-3">Subscriber status</h6>
        <canvas id="subsChart" height="40"></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="card border-0 shadow-sm" style="border-radius: 15px;">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="bg-white">
          <tr>
            <th class="ps-4 py-3 text-muted small">EMAIL</th>
            <th class="py-3 text-muted small">STATUS</th>
            <th class="py-3 text-muted small">JOINED</th>
            <th class="py-3 text-end pe-4 text-muted small">ACTIONS</th>
          </tr>
          </thead>
          <tbody>
          <% subscribers.forEach(sub => { %>
            <tr>
              <td class="ps-4"><%= sub.email %></td>
              <td>
                <% if (sub.is_active) { %>
                  <span class="badge bg-success-subtle text-success">Active</span>
                <% } else { %>
                  <span class="badge bg-secondary-subtle text-secondary">Blocked</span>
                <% } %>
              </td>
              <td class="text-muted small">
                <%= new Date(sub.created_at).toLocaleDateString() %>
              </td>
              <td class="text-end pe-4">
                <form method="post" action="/developer/subscribers/toggle/<%= sub.id %>" class="d-inline">
                  <button class="btn btn-sm <%= sub.is_active ? 'btn-outline-warning' : 'btn-outline-success' %>">
                    <%= sub.is_active ? 'Block' : 'Unblock' %>
                  </button>
                </form>
                <form method="post" action="/developer/subscribers/delete/<%= sub.id %>" class="d-inline" onsubmit="return confirm('Delete this subscriber?');">
                  <button class="btn btn-sm btn-outline-danger ms-1">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
          <% if (subscribers.length === 0) { %>
            <tr>
              <td colspan="4" class="text-center py-4 text-muted">No subscribers yet.</td>
            </tr>
          <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    const ctx = document.getElementById('subsChart').getContext('2d');
    const subsChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Active', 'Blocked'],
        datasets: [{
          data: [<%= stats.active || 0 %>, <%= stats.blocked || 0 %>],
          backgroundColor: ['#198754', '#6c757d'],
          hoverOffset: 4
        }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  </script>

   <%- include('../partials/footer') %>
</body>
</html>